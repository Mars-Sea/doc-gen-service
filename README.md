# Doc-Gen-Service

基于 Spring Boot 的文档生成微服务，使用 **poi-tl** 渲染 Word 模板、**EasyExcel** 处理 Excel 文件。提供 RESTful API 供外部系统（如 Go 服务）调用，支持 Docker 容器化部署。

---

## 目录

- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [环境要求](#环境要求)
- [快速开始](#快速开始)
  - [本地编译运行](#本地编译运行)
  - [Docker 运行](#docker-运行)
- [API 文档](#api-文档)
- [Docker 镜像构建](#docker-镜像构建)
  - [单架构构建](#单架构构建)
  - [多架构构建 (x86_64 + ARM64)](#多架构构建-x86_64--arm64)
- [模板配置](#模板配置)
- [测试指南](#测试指南)
  - [使用 curl 测试](#使用-curl-测试)
  - [使用 Swagger UI](#使用-swagger-ui)

---

## 技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Java | 17 | JDK 版本 |
| Spring Boot | 3.2.1 | Web 框架 |
| poi-tl | 1.12.1 | Word 模板渲染引擎 |
| EasyExcel | 4.0.1 | Excel 处理库 |
| SpringDoc OpenAPI | 2.3.0 | API 文档生成 |
| Lombok | - | 代码简化工具 |

---

## 项目结构

```
doc-gen-service/
├── src/
│   └── main/
│       ├── java/com/example/docgen/
│       │   ├── config/         # 配置类
│       │   ├── controller/     # API 控制器
│       │   ├── model/          # 数据模型
│       │   └── service/        # 业务逻辑
│       └── resources/
│           └── application.yml # 应用配置
├── templates/                  # Word/Excel 模板目录
├── Dockerfile                  # Docker 构建文件
├── docker-compose.yml          # Docker Compose 配置
├── pom.xml                     # Maven 配置
└── payload.json                # 测试请求示例
```

---

## 环境要求

### 本地开发
- **JDK 17+**
- **Maven 3.6+**

### Docker 部署
- **Docker 20.10+**
- **Docker Compose 2.0+** (可选)
- **Docker Buildx** (多架构构建需要)

---

## 快速开始

### 本地编译运行

#### 1. 编译项目

```bash
# 清理并编译，跳过测试
mvn clean package -DskipTests

# 完整编译（包含测试）
mvn clean package
```

编译成功后，JAR 文件生成在 `target/doc-gen-service-0.0.1-SNAPSHOT.jar`。

#### 2. 运行服务

```bash
# 使用默认配置运行
java -jar target/doc-gen-service-0.0.1-SNAPSHOT.jar

# 自定义模板路径和端口
java -jar target/doc-gen-service-0.0.1-SNAPSHOT.jar \
  --docgen.template-path=/path/to/templates \
  --server.port=8081
```

服务启动后访问：
- 服务地址：`http://localhost:8081`
- Swagger UI：`http://localhost:8081/swagger-ui.html`

---

### Docker 运行

#### 使用 Docker Compose (推荐)

```bash
# 先编译 JAR 文件
mvn clean package -DskipTests

# 构建并启动容器
docker-compose up -d --build

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

#### 直接使用 Docker

```bash
# 编译 JAR 文件
mvn clean package -DskipTests

# 构建镜像
docker build -t doc-gen-service:latest .

# 运行容器
docker run -d \
  --name doc-gen-service \
  -p 8081:8081 \
  -v $(pwd)/templates:/app/templates \
  doc-gen-service:latest
```

---

## API 文档

### 生成 Word 文档

**请求**

```http
POST /api/v1/doc/word
Content-Type: application/json
```

**请求体**

```json
{
  "templateName": "test-template.docx",
  "data": {
    "title": "Hello DocGen",
    "date": "2025-01-01",
    "content": "This is a document generated by Spring Boot and poi-tl!"
  },
  "fileName": "my_report"
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `templateName` | string | ✅ | 模板文件名 (需存在于 templates 目录) |
| `data` | object | ✅ | 模板渲染数据 (键值对) |
| `fileName` | string | ❌ | 自定义输出文件名 (不含扩展名，默认: `generated`) |

**响应**

- **成功**: `200 OK`，返回 `.docx` 文件二进制流
- **Content-Disposition**: `attachment; filename=<fileName>.docx`

---

## Docker 镜像构建

### 单架构构建

```bash
# 确保先编译 JAR 文件
mvn clean package -DskipTests

# x86_64 架构
docker build -t doc-gen-service:latest .

# ARM64 架构 (在 ARM 机器上)
docker build -t doc-gen-service:latest-arm64 .
```

---

### 多架构构建 (x86_64 + ARM64)

使用 Docker Buildx 进行多架构构建，可以一次性生成支持多种 CPU 架构的镜像。

#### 1. 准备工作

```bash
# 创建并启用 buildx builder
docker buildx create --name multiarch-builder --use

# 启动 builder
docker buildx inspect --bootstrap

# 查看支持的平台
docker buildx ls
```

#### 2. 构建多架构镜像 (推送到 Docker Hub)

```bash
# 编译 JAR 文件
mvn clean package -DskipTests

# 构建并推送多架构镜像
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  -t your-dockerhub-username/doc-gen-service:latest \
  --push \
  .
```

#### 3. 构建多架构镜像 (保存到本地)

如果不想推送到远程仓库，可以导出为 tar 文件：

```bash
# 导出为 tar 文件
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  -t doc-gen-service:multiarch \
  --output type=oci,dest=doc-gen-service-multiarch.tar \
  .
```

#### 4. 分别构建并保存各架构镜像

```bash
# 构建 ARM64 镜像
docker buildx build --platform linux/arm64 -t doc-gen-service:latest-arm64 --load .

# 构建 AMD64 镜像
docker buildx build --platform linux/amd64 -t doc-gen-service:latest-amd64 --load .
```

#### 5. 创建 Manifest 合并镜像 (推送到仓库)

```bash
# 先分别推送各架构镜像
docker push your-repo/doc-gen-service:latest-amd64
docker push your-repo/doc-gen-service:latest-arm64

# 创建并推送 manifest
docker manifest create your-repo/doc-gen-service:latest \
  your-repo/doc-gen-service:latest-amd64 \
  your-repo/doc-gen-service:latest-arm64

docker manifest push your-repo/doc-gen-service:latest
```

---

## 模板配置

### 模板目录

默认模板路径为 `./templates`，可通过以下方式自定义：

```bash
# 环境变量
export TEMPLATE_PATH=/path/to/templates

# JVM 参数
java -jar app.jar --docgen.template-path=/path/to/templates

# Docker 环境变量
docker run -e TEMPLATE_PATH=/app/templates ...
```

### 模板语法

本服务使用 [poi-tl](http://deepoove.com/poi-tl/) 模板引擎，支持以下语法：

| 语法 | 说明 | 示例 |
|------|------|------|
| `{{variable}}` | 文本替换 | `{{title}}` |
| `{{@image}}` | 图片插入 | `{{@logo}}` |
| `{{#table}}` | 表格循环 | `{{#items}}` |
| `{{?condition}}` | 条件判断 | `{{?showHeader}}` |

### 示例模板结构

Word 模板文件 (`test-template.docx`) 中可包含：

```
标题：{{title}}
日期：{{date}}
内容：{{content}}
```

---

## 测试指南

### 使用 curl 测试

#### 基本测试

```bash
# 简单请求
curl -X POST http://localhost:8081/api/v1/doc/word \
  -H "Content-Type: application/json" \
  -d '{
    "templateName": "test-template.docx",
    "data": {
      "title": "测试文档",
      "date": "2025-01-01",
      "content": "这是一个测试内容"
    }
  }' \
  -o output.docx

# 自定义文件名
curl -X POST http://localhost:8081/api/v1/doc/word \
  -H "Content-Type: application/json" \
  -d '{
    "templateName": "test-template.docx",
    "data": {
      "title": "月度报告",
      "date": "2025-01-31"
    },
    "fileName": "monthly_report_202501"
  }' \
  -o monthly_report_202501.docx
```

#### 使用示例 payload 文件

```bash
curl -X POST http://localhost:8081/api/v1/doc/word \
  -H "Content-Type: application/json" \
  -d @payload.json \
  -o output.docx
```

#### 表格循环测试

```bash
curl -X POST http://localhost:8081/api/v1/doc/word \
  -H "Content-Type: application/json" \
  -d '{
    "templateName": "loop-table-template.docx",
    "data": {
      "title": "订单列表",
      "items": [
        {"name": "商品A", "price": 100, "qty": 2},
        {"name": "商品B", "price": 200, "qty": 1},
        {"name": "商品C", "price": 50, "qty": 5}
      ]
    },
    "fileName": "order_list"
  }' \
  -o order_list.docx
```

---

### 使用 Swagger UI

1. 启动服务后访问: `http://localhost:8081/swagger-ui.html`
2. 找到 **Document Generation** 分组
3. 点击 **POST /api/v1/doc/word** 
4. 点击 **Try it out**
5. 填写请求体并执行

---

## 常见问题

### Q: 多架构构建时出现 QEMU 错误

```bash
# 安装 QEMU 模拟器
docker run --privileged --rm tonistiigi/binfmt --install all
```

### Q: 模板文件找不到

确保模板文件放置在正确的目录，并检查环境变量 `TEMPLATE_PATH` 是否正确配置。

### Q: Docker 容器无法访问模板

检查 volume 挂载是否正确：

```bash
docker run -v /absolute/path/to/templates:/app/templates ...
```

---

## License

MIT License
